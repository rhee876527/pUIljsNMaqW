name: OBS Commit
# OBS_PROJECT_PATH example:
# home:user:project/sub-project *sub-project is optional

#on:
#  push:
on: 
  workflow_run:
    workflows: ['Update checksums']
    types:
      - completed

#  workflow_dispatch

jobs:
  copy-and-commit:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}  
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y osc

    - name: Configure osc
      run: |
        mkdir -p ~/.config/osc
        echo "[general]" > ~/.config/osc/oscrc
        echo "apiurl = https://api.opensuse.org" >> ~/.config/osc/oscrc
        echo "[https://api.opensuse.org]" >> ~/.config/osc/oscrc
        echo "user = ${{ secrets.OBS_USERNAME }}" >> ~/.config/osc/oscrc
        echo "pass = ${{ secrets.OBS_PASSWORD }}" >> ~/.config/osc/oscrc

    - name: Checkout OBS project
      run: |
        osc checkout ${{ secrets.OBS_PROJECT_PATH }}

    - name: Copy PKGBUILD file to OBS project
      run: |
        cp workflow/PKGBUILD ${{ secrets.OBS_PROJECT_PATH }}
        cd ${{ secrets.OBS_PROJECT_PATH }}
        osc add PKGBUILD
        osc commit -m "Update PKGBUILD source from GitHub"
